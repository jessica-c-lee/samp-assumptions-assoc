<!doctype html>
<html>

<head>
	<title> NSW13 </title>
	<script src="./js/jquery.min.js"></script>
	<script src="./js/jspsych.js"></script>
	<script src="./js/plugins/jspsych-text.js"></script>
	<script src="./js/plugins/jspsych-button-response.js"></script>
	<script src="./js/plugins/jspsych-categorize.js"></script>
	<script src="./js/plugins/jspsych-similarity.js"></script>
	<script src="./js/plugins/jspsych-survey-multi-choice.js"></script>
	<script src="./js/plugins/jspsych-survey-likert.js"></script>
	<script src="./js/welcome.js"></script> 
	<link href="./js/css/jspsych.css" rel="stylesheet" type="text/css"></link>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
	<link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/themes/black-tie/jquery-ui.min.css" rel="stylesheet" type="text/css"></link>
</head>

<body>
	<div id="welcome"></div>       
</body>

<script>
//-------------------------------------------------------------------------------- 
/* randomise conditions and stimuli */

var groups = ['single pos', 'distant neg'];
var sampGroups = ['helpful', 'random'];
let group = "" + jsPsych.randomization.sample(groups, 1, false) + "";
let sampGroup = "" + jsPsych.randomization.sample(sampGroups, 1, false) + "";
var dimCB = jsPsych.randomization.sample([1,2], 1);
console.log('group is: ' + group + ', sampling group is: ' + sampGroup + ', dimCB is: ' + dimCB);
var numPres = 4; // number of presentations of each stim during training
var numTestStim = 11; // number of test stimuli
var images = [
'./img/S1.png', 
'./img/S2.png',
'./img/S3.png',
'./img/S4.png',
'./img/S5.png',
'./img/S6.png',
'./img/S7.png',
'./img/S8.png',
'./img/S9.png',
'./img/S10.png',
'./img/S11.png'
];
jsPsych.pluginAPI.preloadImages(images);

if (group === 'single pos') {
	var numCards = '1 card';
} else if (group === 'distant neg') {
	var numCards = '2 cards';
}

//--------------------------------------------------------------------------------  
/* initialise timeline*/

var timeline = [];
var introloop = [];
var turkcode = (Math.floor(Math.random() * 899999) + 100000).toString(); 

//--------------------------------------------------------------------------------  
/* function to start the jsPsych experiment */

function startExperiment() {

  // add properties to each trial in the jsPsych data
  jsPsych.data.addProperties({
  	turkcode: turkcode,
  	group: group,
  	sampGroup: sampGroup,
  	dimCB: dimCB
  });

  jsPsych.init({
  	timeline: timeline,
  	preload_images: images,
  	on_finish: function() { 
  		endExperiment( jsPsych.data.dataAsCSV(), function() { document.write('<div id="endscreen" class="endscreen" style="width:1000px"><div class="endscreen" style="text-align:center; border:0px solid; padding:10px; font-size:120%; width:800px; float:right"><p><br><br><br>All done!<br><br>Your completion code is <span id="turkcode" style="font-weight:bold;font-size:130%">' + turkcode + '</span>. To receive payment for the HIT, return to the Amazon Mechanical Turk page and enter this code. Please contact us if something goes wrong and we\'ll fix it as quickly as possible.</p></div></div>') })
  	}
  });
}

/* save and finish */ 
function endExperiment(dataset,callback) {
  jsPsych.data.displayData() // useful for debugging, comment when running for reals
  // $.post('submit',{"content": dataset}); // uncomment when running for reals
  setTimeout(callback,1000) 
}

//--------------------------------------------------------------------------------
/* change the display property of a set of objects */

function setDisplay(theClass, theValue) {
	var i, classElements = document.getElementsByClassName(theClass);
	for (i = 0; i < classElements.length; i = i + 1) {
		classElements[i].style.display = theValue;
	}
}
//-------------------------------------------------------------------------------- 
/* introloop: 
- includes instructions, sampling manipulation, instruction check, and splash screen
- loops continuously until participant gets questions correct */

var trainIns1 = {
	stimulus: '<div style="text-align:left; border:0px solid; padding:10px;' +
	'                          width:800px; float:right; font-size:100%">' +
	'<p>In this experiment we are interested in how you learn from limited evidence. ' +
	'In the trials that follow, you will be asked to make predictions about outcomes ' +
	'based on the stimuli presented. Please try and be as accurate as possible in ' +
	'your predictions. </p>' +
	'<p>Imagine that you have come across a strange machine. It appears to have a ' +
	'display on it, as well as a label that says "WARNING: this machine gives ' +
	'electric shocks when these symbols are shown: ....". </p>' +
	'<p>The area of the label that shows the symbols has been scratched off, so ' +
	'you do not know which symbols signal danger. </p>' +
	'<p>Your job is to work out which symbols on the machine signal that a shock ' +
	'will occur. </p>'
};

var trainIns2 = {
	stimulus: '<div style="text-align:left; border:0px solid; padding:10px;' +
	'                          width:800px; float:right; font-size:100%">' +
	'<p>As we mentioned before, we are interested in how you make predictions ' +
	'from <b>limited evidence</b>.</p>' +
	'<p>Therefore, although the machine is capable of showing 52 different symbols, ' +
	'you may only be presented with 1 or 2 symbols. </p>' +
	'<p>Please try and learn as much as you can from the symbols you are shown. </p>'
};

if (sampGroup === 'helpful') {
	var sampIns = {
		stimulus: '<div style="text-align:left; border:0px solid; padding:10px;' +
		'                          width:800px; float:right; font-size:100%">' +
		'<p>To make your job easier, we have specifically chosen certain symbols to ' +
		'guide you towards the correct answer. </p>' +
		'<p>Below, there are 52 playing cards representing the 52 possible symbols ' +
		'that can be displayed on the machine. </p>'
	};
} else if (sampGroup === 'random') {
	var sampIns = {
		stimulus: '<div style="text-align:left; border:0px solid; padding:10px;' +
		'                          width:800px; float:right; font-size:100%">' +
		'<p>These symbols will be randomly chosen. </p>' +
		'<p>Below, there are 52 playing cards representing the 52 possible symbols ' +
		'that can be displayed on the machine. </p>' +
		'<p>Please randomly select ' + numCards + ' from the deck by clicking ' +
		'on the card. </p>'
	}
}

/* training instruction block */
var trainInstruction_block = {
	type: 'button-response',
	timing_post_trial: 1,
	button_html: '<button class="jspsych-btn" style="display:none">%choice%</button>',
	choices: ['Click here to continue'],
	on_trial_start: function() { setTimeout(function() {setDisplay("jspsych-btn","")}, 5000)},
	is_html: true,
	timeline: [trainIns1, trainIns2, sampIns]
};
introloop.push(trainInstruction_block); // <- the setup block gets pushed to a "loop node"

//--------------------------------------------------------------------------------
/* sampling manipulation */



//--------------------------------------------------------------------------------
/* instruction check questions */ 

var Q0_text = "<b>Question 1:</b> What is the answer to this question?";
var Q0_answers = ["Something wrong", "Something else wrong", "Something CORRECT"];
var Q1_text = "<b>Question 2:</b> What is the answer to this question?";
var Q1_answers = ["Something wrong", "Something CORRECT", "Something else wrong"];
var correctstring = '{"Q0":"' + Q0_answers[2] + '","Q1":"' + Q1_answers[1] + '"}';

/* define instruction check block */
var instructioncorrect = false; 
var instruction_check = {
	type: "survey-multi-choice",
	preamble: ["<p align='center'><b>Check your knowledge before you begin!</b></p>"],
	questions: [Q0_text, Q1_text],
	options: [Q0_answers, Q1_answers],
	on_finish: function(data) {
		if( data.responses == correctstring) {
			action = false;
			instructioncorrect = true;
		}
	}
}
introloop.push(instruction_check)

/* define a page for the incorrect response */
var showsplash = true;
var splash_screen = {
	type: 'button-response',
	timing_post_trial: 0,
	button_html: '<button class="jspsych-btn" style="display:none">%choice%</button>',
	choices: ['Click here to read the instructions again'],
	on_trial_start: function() { setTimeout(function() {setDisplay("jspsych-btn","")}, 500)},
	is_html: true,
	stimulus: 'Unfortunately, at least one of your answers was incorrect.'
}

/* ...but push it to a conditional node that only shows it if the response was wrong */
var conditional_splash = {
	timeline: [splash_screen],
	conditional_function: function(data) {
        return !instructioncorrect // skip if correct
    }
}
introloop.push(conditional_splash)

/* finally, add the entirety of this introductory section to a loop node ... */
var loop_node = {
	timeline: introloop,
	loop_function: function(data) {
        //var action = true;
        return !instructioncorrect // stop looping if correct
    }
}
timeline.push(loop_node) // ... and add that to the timeline

/* success trial */
var successtrial = {
	type: 'button-response',
	timing_post_trial: 0,
	button_html: '<button class="jspsych-btn" style="display:none">%choice%</button>',
	choices: ['Click here to begin the experiment'],
	on_trial_start: function() { 
		setTimeout(function() {
			setDisplay("jspsych-btn","")
		}, 500)
	},
	is_html: true,
	stimulus: 'Well done!'
};
timeline.push(successtrial);

//-------------------------------------------------------------------------------- 
/* define training stimuli */

var csplus = {
	stimulus: './img/S6.png',
	text_answer: 'SHOCK!',
	key_answer: 65, // keycode for a
	data: {
		dimVal: 6,
		trialType: 'CS+',
		outcome: 1,
		phase: 'train'
	}
};

var csminus = {
	stimulus: './img/S4.png',
	text_answer: 'no shock occurred',
	key_answer: 76, // keycode for l
	data: {
		dimVal: 4,
		trialType: 'CS-',
		outcome: 0,
		phase: 'train'
	}
};

if (dimCB === 2) {	// flip dimension
	var csminus = {
		stimulus: './img/S8.png',
		text_answer: 'no shock occurred',
		key_answer: 76, // keycode for l
		data: {
			dimVal: 4,
			trialType: 'CS-',
			outcome: 0,
			phase: 'train'
		}
	};
}

if (group == 'single pos') {
	var trainStim = csplus;
} else if (group == 'distant neg') {
	var trainStim = [csplus, csminus];
}

/* randomise training order (note that this is completely random) */
var trainSeq = jsPsych.randomization.repeat(trainStim, numPres, unpack=false);

//--------------------------------------------------------------------------------
/* define training block */

var trainBlock = {
	type: 'categorize',
	choices: [65, 76],
	correct_text: '<p><center><font size="+2">Correct! </font></center></p>' +
	'<p><center><font size="+10">%ANS%</font></center></p>',
	incorrect_text: '<p><center><font size="+2">Incorrect </font></center></p>' +
	'<p><center><font size="+10">%ANS%</font></center></p>',
	prompt: '<p>The above picture appears on the machine. Do you think that a ' +
	' shock will occur? </p>' +
	'<p>Press A for SHOCK or L for NO SHOCK. </p>',
	timing_feedback_duration: 5000,
	timeline: trainSeq
};
timeline.push(trainBlock); 

//--------------------------------------------------------------------------------
/* test instruction block */

var testInstruction_block = {
	type: 'button-response',
	timing_post_trial: 1,
	button_html: '<button class="jspsych-btn" style="display:none">%choice%</button>',
	choices: ['Click here to continue'],
	on_trial_start: function() { setTimeout(function() {setDisplay("jspsych-btn","")}, 500)},
	is_html: true,
	timeline: [
	{stimulus: 'For the next few trials, you will be shown some more pictures, but you will NOT be shown feedback about whether a shock occurred. '},
	{stimulus: 'Continue to make predictions about whether you think a shock will occur in the same way as before. '}
	]
};
timeline.push(testInstruction_block); 

//-------------------------------------------------------------------------------- 
/* define test stimuli */ 

if (dimCB === 1) {
	var flipDimVal = 0;
} else if (dimCB === 2) {
	var flipDimVal = -6;
}

var testStim = [{
	stimuli: ['./img/S1.png'],
	data: {
		dimVal: 1 + (flipDimVal * -2),
		trialType: 'GS',
		phase: 'test'
	}
},
{
	stimuli: ['./img/S2.png'],
	data: {
		dimVal: 2 + (flipDimVal * -2),
		trialType: 'GS',
		phase: 'test'
	}
},
{
	stimuli: ['./img/S3.png'], 
	data: {
		dimVal: 3 + (flipDimVal * -2),
		trialType: 'GS',
		phase: 'test'
	}
},
{
	stimuli: ['./img/S4.png'],
	data: {
		dimVal: 4 + (flipDimVal * -2),
		trialType: 'GS',
		phase: 'test'
	}
},
{
	stimuli: ['./img/S5.png'],
	data: {
		dimVal: 5 + (flipDimVal * -2),
		trialType: 'GS',
		phase: 'test'
	}
},
{
	stimuli: ['./img/S6.png'],
	data: {
		dimVal: 6 + (flipDimVal * -2),
		trialType: 'GS',
		phase: 'test'
	}
},
{
	stimuli: ['./img/S7.png'],
	data: {
		dimVal: 7 + (flipDimVal * -2),
		trialType: 'GS',
		phase: 'test'
	}
},
{
	stimuli: ['./img/S8.png'],
	data: {
		dimVal: 8 + (flipDimVal * -2),
		trialType: 'GS',
		phase: 'test'
	}
},
{
	stimuli: ['./img/S9.png'],
	data: {
		dimVal: 9 + (flipDimVal * -2),
		trialType: 'GS',
		phase: 'test'
	}
},
{
	stimuli: ['./img/S10.png'],
	data: {
		dimVal: 10 + (flipDimVal * -2),
		trialType: 'GS',
		phase: 'test'
	}
},
{
	stimuli: ['./img/S11.png'],
	data: {
		dimVal: 11 + (flipDimVal * -2),
		trialType: 'GS',
		phase: 'test'
	}
}
];
//-------------------------------------------------------------------------------- 
/* define test block */ 

var testBlock = {
	type: 'similarity',
	labels: ['Certain NO SHOCK', 'Certain SHOCK'],
	show_ticks: false,
	show_response: 'FIRST_STIMULUS',
	timing_first_stim: 1000,
	timing_second_stim: 0,
	timing_image_gap: 0,
	prompt: 'The above picture appears on the machine. What is the likelihood of this stimulus causing a SHOCK?',
	randomize_order: true,
	timeline: testStim
};
timeline.push(testBlock); 

//--------------------------------------------------------------------------------
/* define questionnaire instructions */ 

var quesInstruction_block = {
	type: 'button-response',
	timing_post_trial: 1,
	button_html: '<button class="jspsych-btn" style="display:none">%choice%</button>',
	choices: ['Click here to continue'],
	on_trial_start: function() { setTimeout(function() {setDisplay("jspsych-btn","")}, 500)},
	is_html: true,
	timeline: [
	{stimulus: '<div style="text-align:left; border:0px solid; padding:10px;' +
	'                          width:800px; float:right; font-size:100%">' +
	'<p>We will now ask you some questions about what you have learned in ' +
	'the experiment.</p>' +
	'<p>Please read each option <b>carefully</b> and answer as honestly as you can.</p>' +
	'<p>You will still receive your payment no matter what.</p>' +
	'<p>There were TWO parts to this experiment. In the first part you ' +
	'received feedback for your predictions, and in the second part you did ' +
	'NOT receive feedback</p>' +
	'<p>We will be asking you the same set of questions for the FIRST ' +
	'<b>and</b> the SECOND part of the experiment.</p>'
}]};
timeline.push(quesInstruction_block); 

//--------------------------------------------------------------------------------
/* define questionnaire */ 

// var likertLabels = ['Definitely untrue', '', '', '', 'Definitely true'];

// var questionnaire = {
// 	type: 'survey-likert',
// 	labels: [likertLabels, likertLabels]
// 	timeline: [
// 	{questions: 'In the FIRST part of the experiment, the SHAPE of the symbol ' +
// 	'determined whether a shock occurred: '},
// 	{questions: 'In the FIRST part of the experiment, the COLOR of the symbol ' +
// 	'determined whether a shock occurred: '},
// 	{questions: 'In the SECOND part of the experiment, the SHAPE of the symbol ' +
// 	'determined whether a shock occurred: '},
// 	{questions: 'In the SECOND part of the experiment, the COLOR of the symbol ' +
// 	'determined whether a shock occurred: '},
// 	]
// };

//--------------------------------------------------------------------------------  
/* start by running the "welcome.js" script */
welcome.run();

</script>
</html>