<!doctype html>
<html>

<head>
	<title> NSW13 </title>
	<script src="./js/jquery.min.js"></script>
	<script src="./js/jspsych.js"></script>
	<script src="./js/plugins/jspsych-instructions.js"></script>
	<script src="./js/plugins/jspsych-html-button-response.js"></script>
	<script src="./js/plugins/jspsych-free-sort.js"></script>
	<script src="./js/plugins/jspsych-categorize-image.js"></script>
	<script src="./js/plugins/jspsych-image-slider-response.js"></script>
	<script src="./js/plugins/jspsych-survey-multi-choice.js"></script>
	<script src="./js/plugins/jspsych-survey-likert.js"></script>
	<script src="./js/welcome.js"></script> 
	<link href="./js/css/jspsych.css" rel="stylesheet" type="text/css"></link>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
	<link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/themes/black-tie/jquery-ui.min.css" rel="stylesheet" type="text/css"></link>
</head>

<body>
	<div id="welcome"></div>       
</body>

<script>
//-------------------------------------------------------------------------------- 
/* randomise conditions and stimuli */

var groups = ['single pos', 'distant neg'];
var sampGroups = ['helpful', 'random'];
let group = "" + jsPsych.randomization.sampleWithReplacement(groups, 1) + "";
let sampGroup = "" + jsPsych.randomization.sampleWithReplacement(sampGroups, 1) + "";
var dimCB = jsPsych.randomization.sampleWithReplacement([1,2], 1);
console.log('group is: ' + group + ', sampling group is: ' + sampGroup + ', dimCB is: ' + dimCB);
var numPres = 4; // number of presentations of each stim during training
var numTestStim = 11; // number of test stimuli
var images = [
'./img/plain_card.jpg', 
'./img/marked_card.jpg',
'./img/S1.png', 
'./img/S2.png',
'./img/S3.png',
'./img/S4.png',
'./img/S5.png',
'./img/S6.png',
'./img/S7.png',
'./img/S8.png',
'./img/S9.png',
'./img/S10.png',
'./img/S11.png'
];
jsPsych.pluginAPI.preloadImages(images);

if (group === 'single pos') {
	var numCards = '1 card';
} else if (group === 'distant neg') {
	var numCards = '2 cards';
}

//--------------------------------------------------------------------------------  
/* initialise timeline*/

var timeline = [];
var introloop = [];
var turkcode = (Math.floor(Math.random() * 899999) + 100000).toString();

//--------------------------------------------------------------------------------  
/* function to start the jsPsych experiment */

function startExperiment() {

  // add properties to each trial in the jsPsych data
  jsPsych.data.addProperties({
  	turkcode: turkcode,
  	group: group,
  	sampGroup: sampGroup,
  	dimCB: dimCB
  });

  jsPsych.init({
  	timeline: timeline,
  	preload_images: images,
  	on_finish: function() { 
  		endExperiment( jsPsych.data.get().csv(), function() { document.write('<div id="endscreen" class="endscreen" style="width:1000px"><div class="endscreen" style="text-align:center; border:0px solid; padding:10px; font-size:120%; width:800px; float:right"><p><br><br><br>All done!<br><br>Your completion code is <span id="turkcode" style="font-weight:bold;font-size:130%">' + turkcode + '</span>. To receive payment for the HIT, return to the Amazon Mechanical Turk page and enter this code. Please contact us if something goes wrong and we\'ll fix it as quickly as possible.</p></div></div>') })
  	}
  });
}

/* save and finish */ 
function endExperiment(dataset,callback) {
  jsPsych.data.displayData() // useful for debugging, comment when running for reals
  // $.post('submit',{"content": dataset}); // uncomment when running for reals
  setTimeout(callback,1000) 
}

//--------------------------------------------------------------------------------
/* change the display property of a set of objects */

function setDisplay(theClass, theValue) {
	var i, classElements = document.getElementsByClassName(theClass);
	for (i = 0; i < classElements.length; i = i + 1) {
		classElements[i].style.display = theValue;
	}
}
//-------------------------------------------------------------------------------- 
/* introloop: 
- includes instructions, sampling manipulation, instruction check, and splash screen
- loops continuously until participant gets questions correct */

var trainIns1 = [
	'<div style="text-align:left; border:0px solid; padding:10px;' +
	'                          width:800px; float:none; font-size:100%">' +
	'<p>In this experiment we are interested in how you learn from limited evidence. ' +
	'In the trials that follow, you will be asked to make predictions about outcomes ' +
	'based on the stimuli presented. Please try and be as accurate as possible in ' +
	'your predictions. </p>' +
	'<p>Imagine that you have come across a strange machine. It appears to have a ' +
	'display on it, as well as a label that says "WARNING: this machine gives ' +
	'electric shocks when these symbols are shown: ....". </p>' +
	'<p>The area of the label that shows the symbols has been scratched off, so ' +
	'you do not know which symbols signal danger. </p>' +
	'<p>Your job is to work out which symbols on the machine signal that a shock ' +
	'will occur. </p>'
];

var trainIns2 = [
	'<div style="text-align:left; border:0px solid; padding:10px;' +
	'                          width:800px; float:none; font-size:100%">' +
	'<p>As we mentioned before, we are interested in how you make predictions ' +
	'from <b>limited evidence</b>.</p>' +
	'<p>Therefore, although the machine is capable of showing 52 different symbols, ' +
	'you may only be presented with 1 or 2 symbols. </p>' +
	'<p>Please try and learn as much as you can from the symbols you are shown. </p>'
];

if (sampGroup === 'helpful') {
	var sampIns = [
		'<div style="text-align:left; border:0px solid; padding:10px;' +
	'                          width:800px; float:none; font-size:100%">' +
		'<p>To make your job easier, we have specifically chosen certain symbols to ' +
		'guide you towards the correct answer. </p>' +
		'<p>Below, there are 52 playing cards representing the 52 possible symbols ' +
		'that can be displayed on the machine. </p>'
	];
} else if (sampGroup === 'random') {
	var sampIns = [
		'<div style="text-align:left; border:0px solid; padding:10px;' +
	'                          width:800px; float:none; font-size:100%">' +
		'<p>These symbols will be randomly chosen. </p>' +
		'<p>Below, there are 52 playing cards representing the 52 possible symbols ' +
		'that can be displayed on the machine. </p>' +
		'<p>Please randomly select ' + numCards + ' from the deck by clicking ' +
		'on the card. </p>'
	]
}

/* training instruction block */
var trainInstruction_block = {
	type: 'instructions',
	pages: [trainIns1, trainIns2, sampIns],
	allow_keys: false,
	show_clickable_nav: true
};
introloop.push(trainInstruction_block); // <- the setup block gets pushed to a "loop node"

//--------------------------------------------------------------------------------
/* sampling manipulation */

if (sampGroup === 'helpful') {
	sampManIns = ['<p>Please drag the <b>' + numCards + '</b> that we have selected for you (marked with an X) to the <b>top</b> of the screen. </p>' +
		'<p>Drag all other cards to the bottom of the screen, you will not see these symbols. </p>'];
} else if (sampGroup === 'random') {
	sampManIns = ['<p>Please randomly choose <b>' + numCards + '</b> and drag to the <b>top</b> of the screen. </p>' +
	'<p>Drag all other cards to the bottom of the screen, you will not see these symbols.</p>'];
}

var numSampCards = 20;

var cardList = Array.apply(null, Array(numSampCards)).map(String.prototype.valueOf,'./img/plain_card.jpg')

if (sampGroup === 'helpful') {
	if (group === 'single pos') {
		cardList = Array.apply(null, Array(numSampCards-1)).map(String.prototype.valueOf,'./img/plain_card.jpg');
		cardList = cardList.concat('./img/marked_card.jpg');
	} else if (group === 'distant neg') {
		cardList = Array.apply(null, Array(numSampCards-2)).map(String.prototype.valueOf,'./img/plain_card.jpg');
		cardList = cardList.concat(['./img/marked_card.jpg', './img/marked_card.jpg']);
	}
}

var sampMan = {
	type: 'free-sort',
	stimuli: cardList,
	stim_height: 180,
	stim_width: 120,
	prompt: sampManIns,
}
introloop.push(sampMan);

//--------------------------------------------------------------------------------
/* instruction check questions */ 

var Q0_text = "<b>Question 1:</b> What is the answer to this question?";
var Q0_answers = ["Something wrong", "Something else wrong", "Something CORRECT"];
var Q1_text = "<b>Question 2:</b> What is the answer to this question?";
var Q1_answers = ["Something wrong", "Something CORRECT", "Something else wrong"];
var correctstring = '{"Q0":"' + Q0_answers[2] + '","Q1":"' + Q1_answers[1] + '"}';


/* define instruction check block */
var instructioncorrect = false; 
var instruction_check = {
	type: "survey-multi-choice",
	preamble: ["<p align='center'><b>Check your knowledge before you begin!</b></p>"],
	questions: [{prompt: Q0_text, options: Q0_answers, required:true,}, 
				{prompt: Q1_text, options: Q1_answers, required: false}],
	on_finish: function(data) {
		if( data.responses == correctstring) {
			action = false;
			instructioncorrect = true;
		}
	}
}
introloop.push(instruction_check)

/* define a page for the incorrect response */
var showsplash = true;
var splash_screen = {
	type: 'html-button-response',
	choices: ['Click here to read the instructions again'],
	stimulus: '<center>Unfortunately, at least one of your answers was incorrect.</center>'
}

/* ...but push it to a conditional node that only shows it if the response was wrong */
var conditional_splash = {
	timeline: [splash_screen],
	conditional_function: function(data) {
        return !instructioncorrect // skip if correct
    }
}
introloop.push(conditional_splash)

/* finally, add the entirety of this introductory section to a loop node ... */
var loop_node = {
	timeline: introloop,
	loop_function: function(data) {
        //var action = true;
        return !instructioncorrect // stop looping if correct
    }
}
timeline.push(loop_node) // ... and add that to the timeline

/* success trial */
var successtrial = {
	type: 'html-button-response',
	post_trial_gap: 0,
	choices: ['Click here to begin the experiment'],
	stimulus: '<center>Well done!</center>'
};
timeline.push(successtrial);

//-------------------------------------------------------------------------------- 
/* define training stimuli */

var csplus = {
	stimulus: './img/S6.png',
	text_answer: 'SHOCK!',
	key_answer: 65, // keycode for a
	data: {
		dimVal: 6,
		trialType: 'CS+',
		outcome: 1,
		phase: 'train'
	}
};

var csminus = {
	stimulus: './img/S4.png',
	text_answer: 'no shock occurred',
	key_answer: 76, // keycode for l
	data: {
		dimVal: 4,
		trialType: 'CS-',
		outcome: 0,
		phase: 'train'
	}
};

if (dimCB === 2) {	// flip dimension
	var csminus = {
		stimulus: './img/S8.png',
		text_answer: 'no shock occurred',
		key_answer: 76, // keycode for l
		data: {
			dimVal: 4,
			trialType: 'CS-',
			outcome: 0,
			phase: 'train'
		}
	};
}

if (group == 'single pos') {
	var trainStim = csplus;
} else if (group == 'distant neg') {
	var trainStim = [csplus, csminus];
}

/* randomise training order (note that this is completely random) */
var trainSeq = jsPsych.randomization.repeat(trainStim, numPres, unpack=false);

//--------------------------------------------------------------------------------
/* define training block */

var trainBlock = {
	type: 'categorize-image',
	choices: [65, 76],
	correct_text: '<p><center><font size="+2">Correct! </font></center></p>' +
	'<p><center><font size="+10">%ANS%</font></center></p>',
	incorrect_text: '<p><center><font size="+2">Incorrect </font></center></p>' +
	'<p><center><font size="+10">%ANS%</font></center></p>',
	prompt: '<center><p>The above picture appears on the machine. Do you think that a ' +
	' shock will occur? </p>' +
	'<p>Press A for SHOCK or L for NO SHOCK. </p></center>',
	timing_feedback_duration: 5000,
	post_trial_gap: 2000,
	timeline: trainSeq
};
timeline.push(trainBlock); 

//--------------------------------------------------------------------------------
/* test instruction block */

var testIns = ['<div style="text-align:left; border:0px solid; padding:10px;' +
	'                          width:800px; float:none; font-size:100%">' +
	'<p>For the next few trials, you will be shown some more pictures, ' +
	'but you will NOT be shown feedback about whether a shock occurred.</p>' +
	'<p>You will still be making predictions about whether you think a shock will occur or not. ' +
	'However this time, you will be making a rating on a scale ranging from ' +
	'"Definitely NO SHOCK" to "Definitely SHOCK". </p>' +
	'<p>Use your mouse to drag the slider along the scale to make your rating. </p>'
];

var testInstruction_block = {
	type: 'instructions',
	pages: [testIns],
	allow_keys: false,
	show_clickable_nav: true
};

timeline.push(testInstruction_block); 

//-------------------------------------------------------------------------------- 
/* define test stimuli */ 

if (dimCB === 1) {
	var flipDimVal = 0;
} else if (dimCB === 2) {
	var flipDimVal = -6;
}

var testStim = [{
	stimulus: ['./img/S1.png'],
	data: {
		dimVal: 1 + (flipDimVal * -2),
		trialType: 'GS',
		phase: 'test'
	}
},
{
	stimulus: ['./img/S2.png'],
	data: {
		dimVal: 2 + (flipDimVal * -2),
		trialType: 'GS',
		phase: 'test'
	}
},
{
	stimulus: ['./img/S3.png'], 
	data: {
		dimVal: 3 + (flipDimVal * -2),
		trialType: 'GS',
		phase: 'test'
	}
},
{
	stimulus: ['./img/S4.png'],
	data: {
		dimVal: 4 + (flipDimVal * -2),
		trialType: 'GS',
		phase: 'test'
	}
},
{
	stimulus: ['./img/S5.png'],
	data: {
		dimVal: 5 + (flipDimVal * -2),
		trialType: 'GS',
		phase: 'test'
	}
},
{
	stimulus: ['./img/S6.png'],
	data: {
		dimVal: 6 + (flipDimVal * -2),
		trialType: 'GS',
		phase: 'test'
	}
},
{
	stimulus: ['./img/S7.png'],
	data: {
		dimVal: 7 + (flipDimVal * -2),
		trialType: 'GS',
		phase: 'test'
	}
},
{
	stimulus: ['./img/S8.png'],
	data: {
		dimVal: 8 + (flipDimVal * -2),
		trialType: 'GS',
		phase: 'test'
	}
},
{
	stimulus: ['./img/S9.png'],
	data: {
		dimVal: 9 + (flipDimVal * -2),
		trialType: 'GS',
		phase: 'test'
	}
},
{
	stimulus: ['./img/S10.png'],
	data: {
		dimVal: 10 + (flipDimVal * -2),
		trialType: 'GS',
		phase: 'test'
	}
},
{
	stimulus: ['./img/S11.png'],
	data: {
		dimVal: 11 + (flipDimVal * -2),
		trialType: 'GS',
		phase: 'test'
	}
}
];

// randomize test order
var testSeq = jsPsych.randomization.repeat(testStim, 1, unpack=false);

//-------------------------------------------------------------------------------- 
/* define test block */ 

var testBlock = {
	type: 'image-slider-response',
	labels: ['Certain NO SHOCK', 'Certain SHOCK'],
	button_label: 'Continue',
	min: 0,
	max: 100,
	start: 50,
	step: 1,
	prompt: '<center><p>The above picture appears on the machine. ' +
			'What is the likelihood of this stimulus causing a SHOCK?</p></center>',
	post_trial_gap: 2000,
	timeline: testSeq
};
timeline.push(testBlock); 

//--------------------------------------------------------------------------------
/* define questionnaire instructions */ 

var quesIns1 = ['<div style="text-align:left; border:0px solid; padding:10px;' +
	'                          width:800px; float:none; font-size:100%">' +
	'<p>We will now ask you some questions about what you have learned in ' +
	'the experiment.</p>' +
	'<p>Please read each option <b>carefully</b> and answer as honestly as you can.</p>' +
	'<p>You will still receive your payment no matter what.</p>'
];

var quesIns2 = ['<div style="text-align:left; border:0px solid; padding:10px;' +
	'                          width:800px; float:none; font-size:100%">' +
	'<p>There were <b>two</b> parts to this experiment. In the <b>first</b> part you ' +
	'received feedback for your predictions, and in the <b>second</b> part you did ' +
	'<b>NOT</b> receive feedback. </p>'
];

var quesInstruction_block = {
	type: 'instructions',
	pages: [quesIns1, quesIns2],
	allow_keys: false,
	show_clickable_nav: true
};

timeline.push(quesInstruction_block); 

//--------------------------------------------------------------------------------
/* define questionnaire */ 

// feature importance
var likertLabels = ['Definitely untrue', 'Probably untrue', 'Neutral', 'Probably true', 'Definitely true'];

var questionnaire = {
	type: 'survey-likert',
	questions: [
	{prompt: 'In the <b>FIRST</b> part of the experiment, the <b>SHAPE</b> of the symbol ' +
	'determined whether a shock occurred: ', labels: likertLabels}, 
	{prompt: 'In the <b>FIRST</b> part of the experiment, the <b>COLOR</b> of the symbol ' +
	'determined whether a shock occurred: ', labels: likertLabels},
    {prompt: 'In the <b>SECOND</b> part of the experiment, the <b>SHAPE</b> of the symbol ' +
	'determined whether a shock occurred: ', labels: likertLabels},
    {prompt: 'In the <b>SECOND</b> part of the experiment, the <b>COLOR</b> of the symbol ' +
	'determined whether a shock occurred: ', labels: likertLabels}
	]
};
timeline.push(questionnaire); 

// forced-choice questions
var questionnaireFC = {
	type: 'survey-multi-choice',
	questions: [
		{prompt: '<font size="+2">If you had to choose, which of the following do you believe is <b>most</b> correct? </font>',
		options: ['Only a specific colored symbol (and those similar to it) led to shock',
		'Colored symbols led to shock',
		'The greener the symbol, the greater the likelihood of shock',
		'The bluer the symbol, the greater the likelihood of shock'],
		required: true, horizontal: false}
	],
	preamble: '<font size="-1">Please read through each option <b>carefully</b></font>'
};
timeline.push(questionnaireFC); 
//-------------------------------------------------------------------------------- 
/* manipulation check */

var manCheck = {
	type: 'survey-multi-choice',
	questions: [
		{prompt: '<font size="+2">Did you believe that the symbols you saw in the <b>first</b> part of the experiment were: </font>',
		options: ['Randomly selected',
		'Selected on purpose in order to be helpful'],
		required: true, horizontal: false}
	],
	preamble: '<font size="-1">Please be as <b>honest</b> as possible. You will still receive your payment. </font>'
};
timeline.push(manCheck); 

//--------------------------------------------------------------------------------  
/* start by running the "welcome.js" script */
welcome.run();

</script>
</html>