<!doctype html>
<html>

<head>
	<title> NSW13 </title>
	<script src="./js/jquery.min.js"></script>
	<script src="./js/jspsych.js"></script>
	<script src="./js/plugins/jspsych-instructions.js"></script>
	<script src="./js/plugins/jspsych-html-button-response.js"></script>
	<script src="./js/plugins/jspsych-html-click.js"></script>
	<script src="./js/plugins/jspsych-free-sort.js"></script>
	<script src="./js/plugins/jspsych-vsl-grid-scene.js"></script>
	<script src="./js/plugins/jspsych-categorize-image.js"></script>
	<script src="./js/plugins/jspsych-image-slider-response.js"></script>
	<script src="./js/plugins/jspsych-survey-multi-choice.js"></script>
	<script src="./js/plugins/jspsych-survey-likert.js"></script>
	<script src="./js/welcome.js"></script> 
	<link href="./js/css/jspsych.css" rel="stylesheet" type="text/css"></link>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
	<link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/themes/black-tie/jquery-ui.min.css" rel="stylesheet" type="text/css"></link>
</head>

<body>
	<div id="welcome"></div> 
	 <!-- <div class="clickable"></div>  -->   
</body>

<script>
//-------------------------------------------------------------------------------- 
/* randomise conditions and stimuli */

var groups = ['single pos', 'distant neg'];
var sampGroups = ['helpful', 'random'];
let group = "" + jsPsych.randomization.sampleWithReplacement(groups, 1) + "";
let sampGroup = "" + jsPsych.randomization.sampleWithReplacement(sampGroups, 1) + "";
var dimCB = jsPsych.randomization.sampleWithReplacement([1,2], 1);
console.log('group is: ' + group + ', sampling group is: ' + sampGroup + ', dimCB is: ' + dimCB);
var numPres = 4; // number of presentations of each stim during training
var numTestStim = 11; // number of test stimuli
var images = [
'./img/plain_card.jpg', 
'./img/marked_card.jpg',
'./img/plain_card_small.jpg', 
'./img/marked_card_small.jpg',
'./img/S1.jpg', 
'./img/S2.jpg',
'./img/S3.jpg',
'./img/S4.jpg',
'./img/S5.jpg',
'./img/S6.jpg',
'./img/S7.jpg',
'./img/S8.jpg',
'./img/S9.jpg',
'./img/S10.jpg',
'./img/S11.jpg',
'./img/checker.jpg'
];
jsPsych.pluginAPI.preloadImages(images);

if (group === 'single pos') {
	var numCards = '1 card';
} else if (group === 'distant neg') {
	var numCards = '2 cards';
}

//--------------------------------------------------------------------------------  
/* initialise timeline*/

var timeline = [];
var introloop = [];
var turkcode = (Math.floor(Math.random() * 899999) + 100000).toString();

//--------------------------------------------------------------------------------  
/* function to start the jsPsych experiment */

function startExperiment() {

  // add properties to each trial in the jsPsych data
  jsPsych.data.addProperties({
  	turkcode: turkcode,
  	group: group,
  	sampGroup: sampGroup,
  	dimCB: dimCB
  });

  jsPsych.init({
  	timeline: timeline,
  	preload_images: images,
  	on_finish: function() { 
  		endExperiment( jsPsych.data.get().csv(), function() { document.write('<div id="endscreen" class="endscreen" style="width:1000px"><div class="endscreen" style="text-align:center; border:0px solid; padding:10px; font-size:120%; width:800px; float:right"><p><br><br><br>All done!<br><br>Your completion code is <span id="turkcode" style="font-weight:bold;font-size:130%">' + turkcode + '</span>. To receive payment for the HIT, return to the Amazon Mechanical Turk page and enter this code. Please contact us if something goes wrong and we\'ll fix it as quickly as possible.</p></div></div>') })
  	}
  });
}

/* save and finish */ 
function endExperiment(dataset,callback) {
  jsPsych.data.displayData() // useful for debugging, comment when running for reals
  // $.post('submit',{"content": dataset}); // uncomment when running for reals
  setTimeout(callback,1000) 
}

//--------------------------------------------------------------------------------
/* change the display property of a set of objects */

function setDisplay(theClass, theValue) {
	var i, classElements = document.getElementsByClassName(theClass);
	for (i = 0; i < classElements.length; i = i + 1) {
		classElements[i].style.display = theValue;
	}
}
//-------------------------------------------------------------------------------- 
/* instructions text */

var ins = {};

ins.train1 = [
	'<div style="text-align:left; border:0px solid; padding:10px;' +
	'                          width:800px; float:none; font-size:100%">' +
	'<p>In this experiment we are interested in how you make predictions from ' +
	' <b>limited</b> evidence. ' +
	'<p>The experiment is composed of three parts. </p>' +
	'<p>In the FIRST part you will learn whether different symbols cause an outcome. ' +
	'On each trial, you will make a prediction, and will be given feedback. </p>' +
	'<p> In the SECOND part you will be presented with some more symbols, ' +
	'and asked to make predictions. But this time, you will NOT be given feedback. </p>'
];

ins.train2 = [
	'In the trials that follow, you will be asked to make predictions about outcomes ' +
	'based on the stimuli presented. Please try and be as accurate as possible in ' +
	'your predictions. </p>' +
	'<p>Imagine that you have come across a strange machine. It appears to have a ' +
	'display on it, as well as a label that says "WARNING: this machine gives ' +
	'electric shocks when these symbols are shown: ....". </p>' +
	'<p>The area of the label that shows the symbols has been scratched off, so ' +
	'you do not know which symbols signal danger. </p>' +
	'<p>Your job is to work out which symbols on the machine signal that a shock ' +
	'will occur. </p>'
];

ins.train3 = [
	'<div style="text-align:left; border:0px solid; padding:10px;' +
	'                          width:800px; float:none; font-size:100%">' +
	'<p>As we mentioned before, we are interested in how you make predictions ' +
	'from <b>limited evidence</b>.</p>' +
	'<p>Therefore, although the machine is capable of showing 52 different symbols, ' +
	'you may only be presented with 1 or 2 symbols. </p>' +
	'<p>Please try and learn as much as you can from the symbols you are shown. </p>'
];

if (sampGroup === 'helpful') {
	ins.samp1 = [
		'<div style="text-align:left; border:0px solid; padding:10px;' +
	'                          width:800px; float:none; font-size:100%">' +
		'<p>To make your job easier, we have specifically chosen certain symbols to ' +
		'guide you towards the correct answer. </p>' +
		'<p>Below, there are 52 playing cards representing the 52 possible symbols ' +
		'that can be displayed on the machine. </p>'
	];
} else if (sampGroup === 'random') {
	ins.samp1 = [
		'<div style="text-align:left; border:0px solid; padding:10px;' +
	'                          width:800px; float:none; font-size:100%">' +
		'<p>These symbols will be randomly chosen. </p>' +
		'<p>Below, there are 52 playing cards representing the 52 possible symbols ' +
		'that can be displayed on the machine. </p>' +
		'<p>Please randomly select ' + numCards + ' from the deck by clicking ' +
		'on the card. </p>'
	]
}

ins.test = ['<div style="text-align:left; border:0px solid; padding:10px;' +
	'                          width:800px; float:none; font-size:100%">' +
	'<p>For the next few trials, you will be shown some more pictures, ' +
	'but you will NOT be shown feedback about whether a shock occurred.</p>' +
	'<p>You will still be making predictions about whether you think a shock will occur or not. ' +
	'However this time, you will be making a rating on a scale ranging from ' +
	'"Definitely NO SHOCK" to "Definitely SHOCK". </p>' +
	'<p>Use your mouse to drag the slider along the scale to make your rating. </p>'
];

ins.ques1 = ['<div style="text-align:left; border:0px solid; padding:10px;' +
	'                          width:800px; float:none; font-size:100%">' +
	'<p>We will now ask you some questions about what you have learned in ' +
	'the experiment.</p>' +
	'<p>Please read each option <b>carefully</b> and answer as honestly as you can.</p>' +
	'<p>You will still receive your payment no matter what.</p>'
];

ins.ques2 = ['<div style="text-align:left; border:0px solid; padding:10px;' +
	'                          width:800px; float:none; font-size:100%">' +
	'<p>There were <b>two</b> parts to this experiment. In the <b>first</b> part you ' +
	'received feedback for your predictions, and in the <b>second</b> part you did ' +
	'<b>NOT</b> receive feedback. </p>'
];
//--------------------------------------------------------------------------------
/* prompt text */

var prompt = {};

prompt.train = '<center><p>The above picture appears on the machine. What do you ' +
	'think will happen? </p>' +
	'<p>Press <b>S</b> for <b>S</b>HOCK </p> <p>or </p> <p><b>N</b> for <b>N</b>O SHOCK. </p></center>';

prompt.test = '<center><p>The above picture appears on the machine. </p>' +
			'<p>What is the likelihood of this stimulus causing a SHOCK?</p></center>';

//--------------------------------------------------------------------------------
/* questionnaire text */

var ques = {};

ques.likertLabels = ['Definitely untrue', 'Probably untrue', 'Neutral', 'Probably true', 'Definitely true'];

ques.feat1 = 'In the <b>FIRST</b> part of the experiment, the <b>SHAPE</b> of the symbol ' +
	'determined whether a shock occurred: ';

ques.feat2 = 'In the <b>FIRST</b> part of the experiment, the <b>COLOR</b> of the symbol ' +
	'determined whether a shock occurred: ';

ques.feat3 = 'In the <b>SECOND</b> part of the experiment, the <b>SHAPE</b> of the symbol ' +
	'determined whether a shock occurred: ';

ques.feat4 = 'In the <b>SECOND</b> part of the experiment, the <b>COLOR</b> of the symbol ' +
	'determined whether a shock occurred: '; 

ques.rulePrompt = '<font size="+2">If you had to choose, which of the following do you believe is <b>most</b> correct? </font>';

ques.ruleOptions = ['Only a specific colored symbol (and those similar to it) led to shock',
		'Colored symbols led to shock',
		'The greener the symbol, the greater the likelihood of shock',
		'The bluer the symbol, the greater the likelihood of shock'];

ques.rulePreamble = '<font size="-1">Please read through each option <b>carefully</b></font>';

ques.manCheckPrompt = '<font size="+2">Did you believe that the symbols you saw in the <b>first</b> part of the experiment were: </font>';

ques.manCheckOptions = ['Randomly selected', 'Selected on purpose in order to be helpful'];

ques.manCheckPreamble = '<font size="-1">Please be as <b>honest</b> as possible. You will still receive your payment. </font>';

//--------------------------------------------------------------------------------
/* introloop: 
- includes instructions, sampling manipulation, instruction check, and splash screen
- loops continuously until participant gets questions correct */

/* training instruction block */
var trainInstruction_block = {
	type: 'instructions',
	pages: [ins.train1, ins.train2, ins.train3, ins.samp1],
	allow_keys: false,
	show_clickable_nav: true
};
introloop.push(trainInstruction_block); // <- the setup block gets pushed to a "loop node"

//--------------------------------------------------------------------------------
/* sampling manipulation */

// create grid of cards
var image_size = 20;
var grid = {};
grid.across = 6;
grid.down = 6;
grid.width = 516;
grid.height = 852;
var row1 = 0;
var col1 = 0;
var row2 = 0;
var col2 = 0;

function fillArray(value, length) {
  var arr = [];
  for (var i = 0; i < length; i++) {
    arr.push(value);
  }
  return arr;
}

// create grid stimulus
grid.row = fillArray('./img/plain_card_small.jpg',grid.across);
grid.markedrow1 = fillArray('./img/plain_card_small.jpg',grid.across);
grid.markedrow2 = fillArray('./img/plain_card_small.jpg',grid.across);
var pattern = [
grid.row, grid.row, grid.row, grid.row, grid.row, grid.row
];

// mark two cards at random in helpful condition (row/col indices)
indices = [0,1,2,3,4,5];
if (sampGroup === 'helpful') {
	if (group === 'single pos') {
		row1 = jsPsych.randomization.sampleWithoutReplacement(indices, 1);
		col1 = jsPsych.randomization.sampleWithoutReplacement(indices, 1);
		grid.markedrow1[col1] = './img/marked_card_small.jpg';
		pattern[row1] = grid.markedrow1;
	} else if (group === 'distant neg') {
		row1 = jsPsych.randomization.sampleWithoutReplacement(indices, 1);
		col1 = jsPsych.randomization.sampleWithoutReplacement(indices, 1);
		row2 = jsPsych.randomization.sampleWithoutReplacement(indices, 1);
		col2 = jsPsych.randomization.sampleWithoutReplacement(indices, 1);
		grid.markedrow1[col1] = './img/marked_card_small.jpg';
		pattern[row1] = grid.markedrow1;
		grid.markedrow2[col2] = './img/marked_card_small.jpg';
		pattern[row2] = grid.markedrow2;
	}
}

// make stimulus
var grid_stimulus = jsPsych.plugins['vsl-grid-scene'].generate_stimulus(pattern, image_size);

// present initial grid, wait for response
var sampMan = {
	type: 'html-click',
	choices: ['Continue'],
	button_html: '<button class="jspsych-btn">%choice%</button>',
	stimulus: [grid_stimulus + '<center><p>Please choose a card by clicking on it</p></center>'],
	data: {
		row1: row1,
		col1: col1,
		row2: row2,
		col2: col2
	on_finish: function getChosenCards() {
		
		var ycoord = y;
		switch (var xcoord = x) {
			case xcoord < grid.width/grid.across:
				var rowIdx = 0;
				break;
			case xcoord >= grid.width/grid.across:
				var rowIdx = 1;
				break;
			case xcoord < grid.width/grid.across:
				var rowIdx = 2;
				break;							
			case xcoord < grid.width/grid.across:
				var rowIdx = 3;
				break;
			case xcoord < grid.width/grid.across:
				var rowIdx = 4;
				break;
			case xcoord < grid.width/grid.across:
				var rowIdx = 5;
				break;
		}
		jsPsych.data.addProperties({x:x, y:y});
	},

	}
}
var getClickNow = false; // so previous mouseclicks aren't registered
var clickCounter = 0;
introloop.push(sampMan)


//--------------------------------------------------------------------------------
/* instruction check questions */ 

var Q0_text = "<b>Question 1:</b> What is the answer to this question?";
var Q0_answers = ["Something wrong", "Something else wrong", "Something CORRECT"];
var Q1_text = "<b>Question 2:</b> What is the answer to this question?";
var Q1_answers = ["Something wrong", "Something CORRECT", "Something else wrong"];
var correctstring = '{"Q0":"' + Q0_answers[2] + '","Q1":"' + Q1_answers[1] + '"}';


/* define instruction check block */
var instructioncorrect = false; 
var instruction_check = {
	type: "survey-multi-choice",
	preamble: ["<p align='center'><b>Check your knowledge before you begin!</b></p>"],
	questions: [{prompt: Q0_text, options: Q0_answers, required:true,}, 
				{prompt: Q1_text, options: Q1_answers, required: false}],
	on_finish: function(data) {
		if( data.responses == correctstring) {
			action = false;
			instructioncorrect = true;
		}
	}
}
introloop.push(instruction_check)

/* define a page for the incorrect response */
var showsplash = true;
var splash_screen = {
	type: 'html-button-response',
	choices: ['Click here to read the instructions again'],
	stimulus: '<center>Unfortunately, at least one of your answers was incorrect.</center>'
}

/* ...but push it to a conditional node that only shows it if the response was wrong */
var conditional_splash = {
	timeline: [splash_screen],
	conditional_function: function(data) {
        return !instructioncorrect // skip if correct
    }
}
introloop.push(conditional_splash)

/* finally, add the entirety of this introductory section to a loop node ... */
var loop_node = {
	timeline: introloop,
	loop_function: function(data) {
        //var action = true;
        return !instructioncorrect // stop looping if correct
    }
}
timeline.push(loop_node) // ... and add that to the timeline

/* success trial */
var successtrial = {
	type: 'html-button-response',
	post_trial_gap: 0,
	choices: ['Click here to begin the experiment'],
	stimulus: '<center>Well done!</center>'
};
timeline.push(successtrial);

//-------------------------------------------------------------------------------- 
/* define training stimuli */

var shockKeyCode = 83; // keycode for s
var noShockKeyCode = 78; // keycode for n

var csplus = {
	stimulus: './img/S6.jpg',
	text_answer: 'SHOCK!',
	key_answer: shockKeyCode,
	data: {
		dimVal: 6,
		trialType: 'CS+',
		outcome: 1,
		phase: 'train'
	}
};

var csminus = {
	stimulus: './img/checker.jpg',
	text_answer: 'no shock occurred',
	key_answer: noShockKeyCode, 
	data: {
		dimVal: 4,
		trialType: 'CS-',
		outcome: 0,
		phase: 'train'
	}
};

if (dimCB === 2) {	// flip dimension
	var csminus = {
		stimulus: './img/S8.jpg',
		text_answer: 'no shock occurred',
		key_answer: noShockKeyCode, 
		data: {
			dimVal: 4,
			trialType: 'CS-',
			outcome: 0,
			phase: 'train'
		}
	};
}

if (group == 'single pos') {
	var trainStim = csplus;
} else if (group == 'distant neg') {
	var trainStim = [csplus, csminus];
}

/* randomise training order (note that this is completely random) */
var trainSeq = jsPsych.randomization.repeat(trainStim, numPres, unpack=false);

//--------------------------------------------------------------------------------
/* define training block */

var trainBlock = {
	type: 'categorize-image',
	choices: [shockKeyCode, noShockKeyCode],
	correct_text: '<p><center><font size="+2">Correct! </font></center></p>' +
	'<p><center><font size="+10">%ANS%</font></center></p>',
	incorrect_text: '<p><center><font size="+2">Incorrect </font></center></p>' +
	'<p><center><font size="+10">%ANS%</font></center></p>',
	prompt: prompt.train,
	timing_feedback_duration: 5000,
	post_trial_gap: 2000,
	timeline: trainSeq
};
timeline.push(trainBlock); 

//--------------------------------------------------------------------------------
/* test instruction block */

var testInstruction_block = {
	type: 'instructions',
	pages: [ins.test],
	allow_keys: false,
	show_clickable_nav: true
};

timeline.push(testInstruction_block); 

//-------------------------------------------------------------------------------- 
/* define test stimuli */ 

if (dimCB === 1) {
	var flipDimVal = 0;
} else if (dimCB === 2) {
	var flipDimVal = -6;
}

var testStim = [{
	stimulus: ['./img/S1.jpg'],
	data: {
		dimVal: 1 + (flipDimVal * -2),
		trialType: 'GS',
		phase: 'test'
	}
},
{
	stimulus: ['./img/S2.jpg'],
	data: {
		dimVal: 2 + (flipDimVal * -2),
		trialType: 'GS',
		phase: 'test'
	}
},
{
	stimulus: ['./img/S3.jpg'], 
	data: {
		dimVal: 3 + (flipDimVal * -2),
		trialType: 'GS',
		phase: 'test'
	}
},
{
	stimulus: ['./img/S4.jpg'],
	data: {
		dimVal: 4 + (flipDimVal * -2),
		trialType: 'GS',
		phase: 'test'
	}
},
{
	stimulus: ['./img/S5.jpg'],
	data: {
		dimVal: 5 + (flipDimVal * -2),
		trialType: 'GS',
		phase: 'test'
	}
},
{
	stimulus: ['./img/S6.jpg'],
	data: {
		dimVal: 6 + (flipDimVal * -2),
		trialType: 'GS',
		phase: 'test'
	}
},
{
	stimulus: ['./img/S7.jpg'],
	data: {
		dimVal: 7 + (flipDimVal * -2),
		trialType: 'GS',
		phase: 'test'
	}
},
{
	stimulus: ['./img/S8.jpg'],
	data: {
		dimVal: 8 + (flipDimVal * -2),
		trialType: 'GS',
		phase: 'test'
	}
},
{
	stimulus: ['./img/S9.jpg'],
	data: {
		dimVal: 9 + (flipDimVal * -2),
		trialType: 'GS',
		phase: 'test'
	}
},
{
	stimulus: ['./img/S10.jpg'],
	data: {
		dimVal: 10 + (flipDimVal * -2),
		trialType: 'GS',
		phase: 'test'
	}
},
{
	stimulus: ['./img/S11.jpg'],
	data: {
		dimVal: 11 + (flipDimVal * -2),
		trialType: 'GS',
		phase: 'test'
	}
}
];

// randomize test order
var testSeq = jsPsych.randomization.repeat(testStim, 1, unpack=false);

//-------------------------------------------------------------------------------- 
/* define test block */ 

var testBlock = {
	type: 'image-slider-response',
	labels: ['Certain NO SHOCK', 'Certain SHOCK'],
	button_label: 'Continue',
	min: 0,
	max: 100,
	start: 50,
	step: 1,
	prompt: prompt.test,
	post_trial_gap: 2000,
	timeline: testSeq
};
timeline.push(testBlock); 

//--------------------------------------------------------------------------------
/* define questionnaire instructions */ 

var quesInstruction_block = {
	type: 'instructions',
	pages: [ins.ques1, ins.ques2],
	allow_keys: false,
	show_clickable_nav: true
};

//timeline.push(quesInstruction_block); 

//--------------------------------------------------------------------------------
/* define questionnaire */ 

var questionnaire = {};

questionnaire.feat = {
	type: 'survey-likert',
	questions: [
	{prompt: ques.feat1, labels: ques.likertLabels, required: true}, 
	{prompt: ques.feat2, labels: ques.likertLabels, required: true}, 
	{prompt: ques.feat3, labels: ques.likertLabels, required: true}, 
	{prompt: ques.feat4, labels: ques.likertLabels, required: true}, 
	]
};
timeline.push(questionnaire.feat); 

// forced-choice questions about rules
questionnaire.rule = {
	type: 'survey-multi-choice',
	questions: [
		{prompt: ques.rulePrompt,
		options: ques.ruleOptions,
		required: true, horizontal: false}
	],
	preamble: ques.rulePreamble
};
timeline.push(questionnaire.rule); 
 
/* manipulation check */

questionnaire.manCheck = {
	type: 'survey-multi-choice',
	questions: [
		{prompt: ques.manCheckPrompt,
		options: ques.manCheckOptions,
		required: true, horizontal: false}
	],
	preamble: ques.manCheckPreamble
};
timeline.push(questionnaire.manCheck); 

//--------------------------------------------------------------------------------  
/* start by running the "welcome.js" script */
welcome.run();

</script>
</html>